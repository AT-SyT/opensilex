 
########################
##GLOBAL VARIABLES 
########################
variables:
 ######Â COMMON CONFIGS ######
 # GIT CONFIG
 GIT_DEPTH: 5
 GIT_OPTIONS: "--allow-unrelated-histories"
 ## BUILD CONFIGS ##
 # MAVEN CONFIG
 # As of Maven 3.3.0 instead of this you may define these options in `.mvn/maven.config` so the same config is used
 # when running from the command line.
 MAVEN_CLI_OPTS: "--batch-mode --show-version "
 BUILD_PATH: "opensilex-release/target/opensilex-release"
 # DEFAULT SERVER MAVEN VERSION
 MVN_VERSION: 3.6.3
 # DEFAULT SERVER JAVA VERSION
 JAVA_VERSION: 11
 ## DEPLOY CONFIGS ##
 # REMOTE SERVER CONFIG
 RSYNC_INSTANCES_OPTIONS: "--progress --delete"
 RSYNC_INSTANCES_PATH: "/home/phis/opensilex-instances/bin"
 RSYNC_INSTANCES_DATA: "/home/phis/opensilex-instances/data"
 RSYNC_INSTANCES_LOGS: "/home/phis/opensilex-instances/logs"
 RSYNC_INSTANCES_LOGS_ARCHIVED: "/home/phis/opensilex-instances/logs/old"
 REVISION: 'INSTANCE-SNAPSHOT'
 DEV_TOOLS_CONFIGURATION_FILES_PATH: "$CI_PROJECT_DIR/opensilex-dev-tools"
 STOP_SERVER_OPTS: "--adminPort=$ADMIN_PORT --host=$REMOTE_SERVER_IP --CONFIG_FILE=$INSTANCE_CONFIGURATION_FILE_NAME"
 START_SERVER_OPTS: "--adminPort=$ADMIN_PORT --host=$REMOTE_SERVER_IP --port=$PORT --CONFIG_FILE=$INSTANCE_CONFIGURATION_FILE_NAME --DEBUG -d"
 # This will supress any download for dependencies and plugins or upload messages which would clutter the console log.
 # `showDateTime` will show the passed time in milliseconds. You need to specify `--batch-mode` to make this work.
 #CACHE
 YARN_CACHE_FOLDER: "$CI_PROJECT_DIR/cache_yarn"
 NODE_CACHE: "$CI_PROJECT_DIR/opensilex-dev/.node"
 EMBDED_MONGO_CACHE: "/root/.embedmongo/"
 

########################
##  DEPLOY OPENSILEX TEST TEMPLATE
########################

.deploy:opensilex:instance: &deploy_opensilex_template
  stage: deploy
  when: manual
  image: instrumentisto/rsync-ssh
  script:
    - apk add curl
    # Create directories
    - ls $CI_PROJECT_DIR/$REVISION
    - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@forgemia.inra.fr:OpenSILEX/opensilex-dev-tools.git
    - echo "Create directory ${RSYNC_INSTANCES_PATH}/${RSYNC_DIR}"
    - echo "Create directory ${RSYNC_INSTANCES_DATA}/${RSYNC_DIR}"
    - echo "Create directory ${RSYNC_INSTANCES_LOGS}"
    - echo "Create directory ${RSYNC_INSTANCES_LOGS_ARCHIVED}"
    - ssh -i ${HOME}/.ssh/id_rsa -p22 $RSYNC_USER@$REMOTE_SERVER_IP "mkdir -p ${RSYNC_INSTANCES_PATH}/${RSYNC_DIR}; mkdir -p ${RSYNC_INSTANCES_LOGS}; mkdir -p ${RSYNC_INSTANCES_LOGS_ARCHIVED}; mkdir -p $RSYNC_INSTANCES_DATA/${RSYNC_DIR};"
    - echo "Upload files"
    - rsync -arzv -e "ssh  -i ${HOME}/.ssh/id_rsa" $RSYNC_INSTANCES_OPTIONS  $CI_PROJECT_DIR/$REVISION/* $RSYNC_USER@$REMOTE_SERVER_IP:${RSYNC_INSTANCES_PATH}/${RSYNC_DIR}
    - echo "scp -i ${HOME}/.ssh/id_rsa -o 'StrictHostKeyChecking no' ${CONFIGURATION_FILES_PATH}/* ${RSYNC_USER}@${REMOTE_SERVER_IP}:${RSYNC_INSTANCES_PATH}/${RSYNC_DIR}"
    - scp -i ${HOME}/.ssh/id_rsa -o "StrictHostKeyChecking no" $CONFIGURATION_FILES_PATH/* $RSYNC_USER@$REMOTE_SERVER_IP:${RSYNC_INSTANCES_PATH}/${RSYNC_DIR}
    - echo "Remove dependencies list cache"
    - ssh -i ${HOME}/.ssh/id_rsa -p22 $REMOTE_SERVER_RSYNC_ACCOUNT@$REMOTE_SERVER_IP "rm -f ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR}/.opensilex.dependencies"
    - echo "Check files"
    - echo ssh -i ${HOME}/.ssh/id_rsa -p22 $REMOTE_SERVER_RSYNC_ACCOUNT@$REMOTE_SERVER_IP "ls ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR};"
    - ssh -i ${HOME}/.ssh/id_rsa -p22 $REMOTE_SERVER_RSYNC_ACCOUNT@$REMOTE_SERVER_IP "ls ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR};"
    - echo "Restart server java -jar ${RSYNC_INSTANCES_BIN_PATH}/$REMOTE_SERVER_RSYNC_DIR/opensilex.jar"
    - echo "Stop with options --adminPort=$OPENSILEX_JAR_ADMIN_PORT --host=$REMOTE_SERVER_IP ${OPENSILEX_STOP_SERVER_OPTS}"
    - ssh -i ${HOME}/.ssh/id_rsa -p22 $REMOTE_SERVER_RSYNC_ACCOUNT@$REMOTE_SERVER_IP "cd ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR}; java -jar ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR}/opensilex.jar server stop --adminPort=$OPENSILEX_JAR_ADMIN_PORT --host=$REMOTE_SERVER_IP ${OPENSILEX_STOP_SERVER_OPTS}"
    - echo "Start with options --adminPort=$OPENSILEX_JAR_ADMIN_PORT --host=$REMOTE_SERVER_IP ${OPENSILEX_START_SERVER_OPTS}"
    - ssh -i ${HOME}/.ssh/id_rsa -p22 $REMOTE_SERVER_RSYNC_ACCOUNT@$REMOTE_SERVER_IP "cd ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR}; java -jar ${RSYNC_INSTANCES_BIN_PATH}/${REMOTE_SERVER_RSYNC_DIR}/opensilex.jar server start --adminPort=$OPENSILEX_JAR_ADMIN_PORT --host=$REMOTE_SERVER_IP ${OPENSILEX_START_SERVER_OPTS}"
    - DYNAMIC_ENVIRONMENT_URL="http://$REMOTE_SERVER_IP:$OPENSILEX_JAR_PORT"        
    - echo "Deploy To $DYNAMIC_ENVIRONMENT_URL"                 # In script, get the environment URL.
    - echo "DYNAMIC_ENVIRONMENT_URL=$DYNAMIC_ENVIRONMENT_URL" >> deploy.env 
  except:
    - schedules    
    
# #########
# Arnaud
# #########

arnaud:build:
  <<: *build_template_with_opensilex
  script: 
    - mvn install $MAVEN_CLI_OPTS -Drevision=$REVISION
    - mv $BUILD_PATH/opensilex-release-$REVISION $CI_PROJECT_DIR/$REVISION
  artifacts:
    paths:
      - public

# ##########################################
# ##  BUILD & DEPLOY FOR MISTEA TEAM
# ##########################################
 
###################################
##  ALICE-TEST-SNAPSHOT-DEPLOYMENT
###################################

alice:build:
  <<: *build_template_with_opensilex
  only:
    - arnaud
    
    
###################################
##  ARNAUD-TEST-SNAPSHOT-DEPLOYMENT
###################################

test:arnaud:deploy:
  <<: *deploy_opensilex_before_script
  <<: *deploy_opensilex_template
  when: on_success  
  variables:
    RSYNC_USER: "phis"
    REMOTE_SERVER_IP: "138.102.159.37"
    RSYNC_DIR: "mistea/arnaud"
    CONFIGURATION_FILES_PATH: "$DEV_TOOLS_CONFIGURATION_FILES_PATH/mistea/arnaud"
    INSTANCE_CONFIGURATION_FILE_NAME: "phis.test.yml"
    SSH_KEY: "$TEST_SSH_PRIVATE_KEY"
    ADMIN_PORT: 4086
    PORT: 8086
    PROJECT_ID: 403
    BRANCH: arnaud
  only:
    - arnaud
  environment:
    name: arnaud-test
    url: http://138.102.159.37:8086
  needs:
    - arnaud:build
